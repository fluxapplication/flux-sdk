<!DOCTYPE html>
<html>

<head>
    <title>Flux Extension Sandbox</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #111;
            color: #eee;
        }

        header {
            padding: 16px;
            background: #222;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        header img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 80%;
        }

        .message.user {
            background: #005c4b;
            align-self: flex-end;
        }

        .message.bot {
            background: #333;
            align-self: flex-start;
        }

        .message .sender {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .message .text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        #input-area {
            padding: 16px;
            background: #222;
            border-top: 1px solid #333;
            display: flex;
            gap: 8px;
        }

        input {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #111;
            color: white;
            outline: none;
        }

        #input-area button {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            background: #8b5cf6;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        #input-area button:hover {
            background: #7c3aed;
        }

        #ui-mount {
            border-bottom: 1px solid #333;
            height: 100%;
            overflow-y: auto;
        }
    </style>
    <!-- Add Tailwind logic -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base tabs styling */
        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            color: #ccc;
        }

        .tab-btn.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <header>
        <img id="ext-icon" src="/icon.png" alt="Icon"
            onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
        <div>
            <div id="ext-name" style="font-weight: bold;">Loading...</div>
            <div id="ext-slug" style="font-size: 12px; opacity: 0.7;">sandbox</div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" data-target="chat-content">Chat</button>
        <button class="tab-btn" data-target="ui-mount">App UI</button>
        <button class="tab-btn" data-target="settings-mount">App Settings</button>
    </div>

    <!-- Chat Tab -->
    <div id="chat-content" class="tab-content active">
        <div id="chat">
            <div class="message bot">
                <div class="sender">Sandbox System</div>
                <div class="text">Welcome to the local development sandbox. Type a message below to test your
                    extension's
                    onMessage handler.</div>
            </div>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="Type a message to the channel..." autocomplete="off" />
            <button id="send-btn">Send</button>
        </div>
    </div>

    <!-- App UI Tab -->
    <div id="ui-mount" class="tab-content"></div>

    <!-- Settings UI Tab -->
    <div id="settings-mount" class="tab-content"></div>

    <!-- React dependencies for extension UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Provide a require shim for esbuild's external references -->
    <script>
        window.require = function (mod) {
            if (mod === 'react') return window.React;
            if (mod === 'react-dom') return window.ReactDOM;
            if (mod === 'react/jsx-runtime') {
                return {
                    jsx: window.React.createElement,
                    jsxs: window.React.createElement,
                    Fragment: window.React.Fragment
                };
            }
            if (mod === 'lucide-react') {
                return window.lucide || new Proxy({}, {
                    get: function (target, prop) {
                        if (prop === '__esModule') return true;
                        return function () {
                            return window.React.createElement('span', { style: { fontSize: '10px', color: '#888' } }, `[${prop}]`);
                        };
                    }
                });
            }
            throw new Error('Module not found in sandbox environment: ' + mod);
        };
    </script>

    <script>
        // Tab Switching Logic
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                const targetId = btn.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });

        const chat = document.getElementById('chat');
        const input = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        let manifest = {};

        // Fetch manifest
        fetch('/manifest.json')
            .then(r => r.json())
            .then(m => {
                manifest = m;
                document.getElementById('ext-name').textContent = m.name;
                document.getElementById('ext-slug').textContent = m.slug;
                document.title = `Sandbox: ${m.name}`;
            })
            .catch(console.error);

        function appendMessage(sender, text, isBot) {
            const div = document.createElement('div');
            div.className = `message ${isBot ? 'bot' : 'user'}`;
            let htmlInner = `<div class="sender">${sender}</div>`;
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.textContent = text;
            div.innerHTML = htmlInner;
            div.appendChild(textDiv);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // SSE for bot messages
        const events = new EventSource('/api/events');
        events.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            appendMessage(msg.user.name, msg.content, true);
        };

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            appendMessage('You', text, false);

            await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: text })
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        // We load the frontend bundle as well
        const script = document.createElement('script');
        script.src = '/bundle.js';

        // Fake Context API for React components
        const frontendCtx = {
            workspaceId: 'sandbox-workspace',
            channels: [
                { id: 'C_SANDBOX_1', name: 'general' },
                { id: 'C_SANDBOX_2', name: 'dev-team' }
            ],
            serverUrl: `http://${window.location.host}`,
            storage: {
                get: async (key) => {
                    const res = await fetch('/api/storage?key=' + encodeURIComponent(key));
                    const data = await res.json();
                    return data.value;
                },
                set: async (key, value) => {
                    await fetch('/api/storage', {
                        method: 'POST',
                        body: JSON.stringify({ key, value })
                    });
                },
                delete: async (key) => {
                    await fetch('/api/storage', {
                        method: 'POST',
                        body: JSON.stringify({ key, value: null })
                    });
                },
                listKeys: async () => []
            }
        };

        let appMounted = false;
        let settingsMounted = false;

        const tryMount = () => {
            if (window.__FluxExtension__) {
                const ext = window.__FluxExtension__.default || window.__FluxExtension__;

                if (ext.ExtensionPage && !appMounted) {
                    const uiMount = document.getElementById('ui-mount');
                    const root = ReactDOM.createRoot(uiMount);
                    root.render(React.createElement(ext.ExtensionPage, { ctx: frontendCtx, currentUserId: 'user-1' }));
                    appMounted = true;
                    console.log("[Sandbox] Mounted ExtensionPage");
                }

                if (ext.ExtensionPanel && !settingsMounted) {
                    const settingsMount = document.getElementById('settings-mount');
                    if (settingsMount) {
                        const root = ReactDOM.createRoot(settingsMount);
                        root.render(React.createElement(ext.ExtensionPanel, { ctx: frontendCtx, currentUserId: 'user-1' }));
                        settingsMounted = true;
                        console.log("[Sandbox] Mounted ExtensionPanel");
                    }
                }
            }

            // Loop for a while just in case it takes time to define things
            if (!appMounted && !settingsMounted) {
                setTimeout(tryMount, 50);
            }
        };

        script.onload = () => {
            tryMount();
        };
        document.body.appendChild(script);

    </script>
</body>

</html>